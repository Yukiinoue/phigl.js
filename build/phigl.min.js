/*
 * phigl.js 1.1.2-pre
 * https://github.com/daishihmr/phigl.js
 * 
 * The MIT License (MIT)
 * Copyright © 2016-2017 daishihmr <daishi.hmr@gmail.com> (http://github.dev7.jp/)
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and
 * associated documentation files (the “Software”), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
 * of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following
 * conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all copies or substantial portions
 * of the Software.
 * 
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
phina.namespace(function(){phina.define("phigl.Attribute",{gl:null,name:null,_location:null,_type:null,_ptype:null,_offset:0,init:function(t,i,e,n){if(this.gl=t,this.name=e,this._location=t.getAttribLocation(i,e),this._location==-1)throw"attribute "+e+" not found";switch(t.enableVertexAttribArray(this._location),this._type=n,n){case t.FLOAT:this.size=1,this._ptype=t.FLOAT;break;case t.FLOAT_VEC2:this.size=2,this._ptype=t.FLOAT;break;case t.FLOAT_VEC3:this.size=3,this._ptype=t.FLOAT;break;case t.FLOAT_VEC4:this.size=4,this._ptype=t.FLOAT}},specify:function(t){var i=this.gl;return i.vertexAttribPointer(this._location,this.size,this._ptype,!1,t,this._offset),this}})}),phina.namespace(function(){phina.define("phigl.Detector",{_static:{isEnable:function(){try{var t=document.createElement("canvas"),i=t.getContext("webgl")||t.getContext("experimental-webgl");return!!(window.WebGLRenderingContext&&i&&i.getShaderPrecisionFormat)}catch(e){return!1}}()}})}),phina.namespace(function(){phina.define("phigl.Drawable",{superClass:"phina.util.EventDispatcher",gl:null,extVao:null,program:null,indices:null,attributes:null,stride:0,uniforms:null,vbo:null,drawMode:0,vao:null,init:function(t,i){this.superInit(),this.gl=t,this.extVao=i,this.attributes=[],this.uniforms={},this.drawMode=t.TRIANGLES},setDrawMode:function(t){return this.drawMode=t,this},setProgram:function(t){return this.program=t,t.use(),this},setIndexValues:function(t){return this.indices||(this.indices=phigl.Ibo(this.gl)),this.indices.set(t),this},setIndexBuffer:function(t){return this.indices=t,this},declareAttributes:function(t){t=Array.prototype.concat.apply([],arguments);for(var i=0,e=0;e<t.length;e++){var n=t[e];"string"==typeof n&&(n=this.program.getAttribute(n)),this.attributes.push(n),n._offset=i,i+=4*n.size}return this.stride=i,this},setAttributes:function(t){return console.warn("deprecated"),this.declareAttributes(t)},setAttributeData:function(t,i){this.vbo||(this.vbo=phigl.Vbo(this.gl,i)),this.vbo.set(t),this.vbo.bind();var e=this.stride;return this.attributes.forEach(function(t,i){t.specify(e)}),phigl.Vbo.unbind(this.gl),this},setAttributeDataArray:function(t,i){this.vbo||(this.vbo=phigl.Vbo(this.gl,i)),this.vbo.setAsInterleavedArray(t),this.vbo.bind();var e=this.stride;return this.attributes.forEach(function(t,i){t.specify(e)}),phigl.Vbo.unbind(this.gl),this},setAttributeVbo:function(t){this.vbo=t,this.vbo.bind();var i=this.stride;return this.attributes.forEach(function(t,e){t.specify(i)}),phigl.Vbo.unbind(this.gl),this},createVao:function(){var t=this.gl,i=this.stride;return this.extVao||(this.extVao=phigl.Extensions.getVertexArrayObject(t)),this.vao||(this.vao=this.extVao.createVertexArrayOES()),this.extVao.bindVertexArrayOES(this.vao),this.indices&&this.indices.bind(),this.vbo&&this.vbo.bind(),this.attributes.forEach(function(e,n){e.specify(i),t.enableVertexAttribArray(e._location)}),this.extVao.bindVertexArrayOES(null),phigl.Ibo.unbind(t),phigl.Vbo.unbind(t),this},declareUniforms:function(t){t=Array.prototype.concat.apply([],arguments);var i=this.program,e=Array.prototype.reduce.call(t,function(t,e){return t[e]=i.getUniform(e),t},{});return this.uniforms.$extend(e),this},setUniforms:function(t){return console.warn("deprecated"),this.declareUniforms(t)},draw:function(){var t=this.gl,i=this.extVao;if(this.program.use(),this.vao)i.bindVertexArrayOES(this.vao);else{this.indices&&this.indices.bind(),this.vbo&&this.vbo.bind();var e=this.stride;this.attributes.forEach(function(t,i){t.specify(e)})}this.uniforms.forIn(function(t,i){i.assign()}),this.flare("predraw"),this.gl.drawElements(this.drawMode,this.indices.length,t.UNSIGNED_SHORT,0),this.flare("postdraw"),this.vao?i.bindVertexArrayOES(null):(phigl.Ibo.unbind(t),phigl.Vbo.unbind(t)),this.uniforms.forIn(function(t,i){i.reassign()})},"delete":function(){var t=(this.gl,this.ext);this.vao?t.deleteVertexArrayOES(this.vao):(this.indices["delete"](),this.vbo["delete"]())}})}),phina.namespace(function(){phina.define("phigl.Extensions",{_static:{extVao:null,extInstancedArray:null,getVertexArrayObject:function(t){return null==this.extVao&&(this.extVao=this._get(t,"OES_vertex_array_object")),this.extVao},getInstancedArrays:function(t){return null==this.extInstancedArray&&(this.extInstancedArray=this._get(t,"ANGLE_instanced_arrays")),this.extInstancedArray},_get:function(t,i){var e=t.getExtension(i);if(e)return e;throw i+" is not supported"}}})}),phina.namespace(function(){phina.define("phigl.Framebuffer",{gl:null,texture:null,_framebuffer:null,_depthRenderbuffer:null,_texture:null,init:function(t,i,e){this.gl=t,this.width=i,this.height=e,this.texture=phigl.Texture(t),this._framebuffer=t.createFramebuffer(),this._depthRenderbuffer=t.createRenderbuffer(),this._texture=this.texture._texture,t.bindFramebuffer(t.FRAMEBUFFER,this._framebuffer),t.bindRenderbuffer(t.RENDERBUFFER,this._depthRenderbuffer),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,i,e),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this._depthRenderbuffer),t.bindTexture(t.TEXTURE_2D,this._texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,i,e,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this._texture,0),t.bindTexture(t.TEXTURE_2D,null),t.bindRenderbuffer(t.RENDERBUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,null)},bind:function(){var t=this.gl;return t.bindFramebuffer(t.FRAMEBUFFER,this._framebuffer),t.viewport(0,0,this.width,this.height),this},_static:{unbind:function(t){t.bindFramebuffer(t.FRAMEBUFFER,null)}}})}),phina.namespace(function(){phina.define("phigl.Ibo",{gl:null,length:0,_buffer:null,init:function(t){this.gl=t,this._buffer=t.createBuffer()},set:function(t){var i=this.gl;return i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this._buffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,new Int16Array(t),i.STATIC_DRAW),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),this.length=t.length,this},bind:function(){return this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this._buffer),this},"delete":function(){this.gl.deleteBuffer(this._buffer)},_static:{unbind:function(t){return t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),this}},_accessor:{value:{get:function(){return null},set:function(t){this.set(t)}}}})}),phina.namespace(function(){phina.define("phigl.ImageUtil",{init:function(){},_static:{resizePowOf2:function(t,i,e){if("string"==typeof t&&(t=phina.asset.AssetManager.get("image",t).domElement),Math.sqrt(t.width)%1==0&&Math.sqrt(t.height)%1==0)return t;var n=Math.pow(2,Math.ceil(Math.log2(t.width))),r=Math.pow(2,Math.ceil(Math.log2(t.height))),s=phina.graphics.Canvas().setSize(n,r),a=i?n:t.width,h=e?r:t.height;return s.context.drawImage(t,0,0,t.width,t.height,0,0,a,h),s}}})}),phina.namespace(function(){phina.define("phigl.InstancedDrawable",{superClass:"phigl.Drawable",instanceAttributes:null,ext:null,instanceVbo:null,instanceStride:0,init:function(t,i){this.superInit(t),this.ext=i,this.instanceAttributes=[]},declareInstanceAttributes:function(t){t=Array.prototype.concat.apply([],arguments);for(var i=(this.gl,this.ext,0),e=0;e<t.length;e++){var n=t[e];"string"==typeof n&&(n=this.program.getAttribute(n)),this.instanceAttributes.push(n),n._offset=i,i+=4*n.size}return this.instanceStride=i,this},setInstanceAttributes:function(t){return console.warn("deprecated"),this.declareInstanceAttributes(t)},setInstanceAttributeVbo:function(t){this.instanceVbo=t,this.instanceVbo.bind();var i=this.instanceStride;return this.instanceAttributes.forEach(function(t,e){t.specify(i)}),phigl.Vbo.unbind(this.gl),this},setInstanceAttributeData:function(t){this.instanceVbo||(this.instanceVbo=phigl.Vbo(this.gl,this.gl.DYNAMIC_DRAW)),this.instanceVbo.set(t),this.instanceVbo.bind();var i=this.instanceStride;return this.instanceAttributes.forEach(function(t,e){t.specify(i)}),phigl.Vbo.unbind(this.gl),this},setInstanceAttributeDataArray:function(t){this.instanceVbo||(this.instanceVbo=phigl.Vbo(this.gl)),this.instanceVbo.setAsInterleavedArray(t),this.instanceVbo.bind();var i=this.instanceStride;return this.instanceAttributes.forEach(function(t,e){t.specify(i)}),phigl.Vbo.unbind(this.gl),this},createVao:function(){return this},draw:function(t){var i=this.gl,e=this.ext;this.program.use(),this.indices&&this.indices.bind(),this.vbo&&this.vbo.bind();var n=this.stride;this.attributes.forEach(function(t,i){t.specify(n)}),this.instanceVbo&&this.instanceVbo.bind();var r=this.instanceStride;this.instanceAttributes.forEach(function(t,i){t.specify(r),e.vertexAttribDivisorANGLE(t._location,1)}),this.uniforms.forIn(function(t,i){i.assign()}),this.flare("predraw"),this.ext.drawElementsInstancedANGLE(this.drawMode,this.indices.length,i.UNSIGNED_SHORT,0,t),this.flare("postdraw"),this.instanceAttributes.forEach(function(t,i){e.vertexAttribDivisorANGLE(t._location,0)}),phigl.Ibo.unbind(i),phigl.Vbo.unbind(i)}})}),phina.namespace(function(){phina.define("phigl.PostProcessing",{gl:null,drawer:null,width:0,height:0,init:function(t,i,e,n,r){this.gl=t,"string"==typeof i&&(i=phigl.PostProcessing.createProgram(t,i)),n=n||256,r=r||256,e=e||[];var s=Math.pow(2,Math.ceil(Math.log2(n))),a=Math.pow(2,Math.ceil(Math.log2(r)));this.drawer=phigl.Drawable(t).setDrawMode(t.TRIANGLE_STRIP).setProgram(i).setIndexValues([0,1,2,3]).setAttributes("position","uv").setAttributeData([-1,1,0,r/a,1,1,n/s,r/a,-1,-1,0,0,1,-1,n/s,0]).setUniforms(["texture","canvasSize"].concat(e)),this.width=n,this.height=r,this.sqWidth=s,this.sqHeight=a},render:function(t,i){this.gl;return this.drawer.uniforms.texture.setValue(0).setTexture(t),this.drawer.uniforms.canvasSize.value=[this.sqWidth,this.sqHeight],i&&this.setUniforms(i),this.drawer.draw(),this},setUniforms:function(t){var i=this.drawer.uniforms;t.forIn(function(t,e){i[t].value=e})},calcCoord:function(t,i){return[t/this.sqWidth,(this.height-i)/this.sqHeight]},_static:{vertexShaderSource:["attribute vec2 position;","attribute vec2 uv;","varying vec2 vUv;","void main(void) {","  vUv = uv;","  gl_Position = vec4(position, 0.0, 1.0);","}"].join("\n"),createProgram:function(t,i){var e=phigl.VertexShader(t);return e.data=this.vertexShaderSource,phigl.Program(t).attach(e).attach(i).link()}}})}),phina.namespace(function(){var t=0;phina.define("phigl.Program",{_static:{currentUsing:null},gl:null,linked:!1,_program:null,_vbo:null,_attributes:null,_uniforms:null,_shaders:null,init:function(i){this.gl=i,this._program=i.createProgram(),this._program._id=t++,this.linked=!1,this._attributes={},this._uniforms={},this._shaders=[]},attach:function(t){var i=this.gl;return"string"==typeof t&&(t=phina.asset.AssetManager.get("vertexShader",t)||phina.asset.AssetManager.get("fragmentShader",t)),t.compiled||t.compile(i),i.attachShader(this._program,t._shader),this._shaders.push(t),this},link:function(){var t=this.gl;if(t.linkProgram(this._program),t.getProgramParameter(this._program,t.LINK_STATUS)){for(var i=t.getProgramParameter(this._program,t.ACTIVE_ATTRIBUTES),e=0;e<i;e++){var n=t.getActiveAttrib(this._program,e);this.getAttribute(n.name,n.type)}for(var r=t.getProgramParameter(this._program,t.ACTIVE_UNIFORMS),e=0;e<r;e++){var s=t.getActiveUniform(this._program,e);this.getUniform(s.name,s.type)}return this.linked=!0,this}throw this.linked=!1,t.getProgramInfoLog(this._program)},getAttribute:function(t,i){return this._attributes[t]||(this._attributes[t]=phigl.Attribute(this.gl,this._program,t,i)),this._attributes[t]},getUniform:function(t,i){return this._uniforms[t]||(this._uniforms[t]=phigl.Uniform(this.gl,this._program,t,i)),this._uniforms[t]},use:function(){return phigl.Program.currentUsing===this?this:(this.gl.useProgram(this._program),phigl.Program.currentUsing=this,this)},"delete":function(){var t=this.gl,i=this._program;return this._shaders.forEach(function(e){t.detachShader(i,e._shader)}),this._shaders.forEach(function(i){t.deleteShader(i._shader)}),t.deleteProgram(i),this}})}),phina.namespace(function(){phina.define("phigl.Shader",{superClass:"phina.asset.File",type:null,gl:null,compiled:!1,_shader:null,init:function(){this.superInit(),this.compiled=!1},compile:function(t){if(this.gl=t,this.type=this._type(t),this._shader=t.createShader(this.type),t.shaderSource(this._shader,this.data),t.compileShader(this._shader),t.getShaderParameter(this._shader,t.COMPILE_STATUS))return this.compiled=!0,this;throw this.compiled=!1,t.getShaderInfoLog(this._shader)},_type:function(t){return 0}}),phina.define("phigl.VertexShader",{superClass:"phigl.Shader",init:function(){this.superInit()},_type:function(t){return t.VERTEX_SHADER}}),phina.asset.AssetLoader.assetLoadFunctions.vertexShader=function(t,i){var e=phigl.VertexShader();return e.load({path:i})},phina.define("phigl.FragmentShader",{superClass:"phigl.Shader",init:function(){this.superInit()},_type:function(t){return t.FRAGMENT_SHADER}}),phina.asset.AssetLoader.assetLoadFunctions.fragmentShader=function(t,i){var e=phigl.FragmentShader();return e.load({path:i})}}),phina.namespace(function(){phina.define("phigl.Texture",{gl:null,_texture:null,init:function(t,i){this.gl=t,this._texture=t.createTexture(),i&&this.setImage(i)},setImage:function(t){var i=this.gl;return"string"==typeof t&&(t=phina.asset.AssetManager.get("image",t)),i.bindTexture(i.TEXTURE_2D,this._texture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t.domElement),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.generateMipmap(i.TEXTURE_2D),i.bindTexture(i.TEXTURE_2D,null),this},bind:function(t){var i=this.gl;return i.activeTexture(i["TEXTURE"+(t||0)]),i.bindTexture(i.TEXTURE_2D,this._texture),this},"delete":function(){this.gl.deleteTexture(this._texture)},_static:{unbind:function(t){return t.bindTexture(t.TEXTURE_2D,null),this}}})}),phina.namespace(function(){phina.define("phigl.Uniform",{gl:null,name:null,texture:null,_location:null,_value:null,_type:null,_uniformMethod:null,init:function(t,i,e,n){switch(this.gl=t,this.name=e,this._location=t.getUniformLocation(i,e),this._type=n,n){case t.FLOAT:this._uniformMethod="uniform1f";break;case t.FLOAT_VEC2:this._uniformMethod="uniform2fv";break;case t.FLOAT_VEC3:this._uniformMethod="uniform3fv";break;case t.FLOAT_VEC4:this._uniformMethod="uniform4fv";break;case t.FLOAT_MAT2:this._uniformMethod="uniformMatrix2fv";break;case t.FLOAT_MAT3:this._uniformMethod="uniformMatrix3fv";break;case t.FLOAT_MAT4:this._uniformMethod="uniformMatrix4fv";break;case t.SAMPLER_2D:this._uniformMethod="uniform1i"}},setValue:function(t){return this._value=t,this},setTexture:function(t){return"string"==typeof t&&(t=phigl.Texture(this.gl,t)),this.texture=t,this},assign:function(){var t=this.gl;switch(this._type){case t.FLOAT:case t.FLOAT_VEC2:case t.FLOAT_VEC3:case t.FLOAT_VEC4:t[this._uniformMethod](this._location,this._value);break;case t.FLOAT_MAT2:case t.FLOAT_MAT3:case t.FLOAT_MAT4:t[this._uniformMethod](this._location,!1,this._value);break;case t.SAMPLER_2D:this.texture&&this.texture.bind(this._value),t[this._uniformMethod](this._location,this._value)}return this},reassign:function(){var t=this.gl;switch(this._type){case t.SAMPLER_2D:this.texture&&phigl.Texture.unbind(t)}return this},_accessor:{value:{get:function(){return this._value},set:function(t){this.setValue(t)}}}})}),phina.namespace(function(){var t=0;phina.define("phigl.Vbo",{gl:null,usage:null,_vbo:null,array:null,init:function(i,e){this.gl=i,this.usage=e||i.STATIC_DRAW,this._vbo=i.createBuffer(),this._vbo._id=t++},set:function(t){var i=this.gl;return this.array?this.array.set(t):this.array=new Float32Array(t),i.bindBuffer(i.ARRAY_BUFFER,this._vbo),i.bufferData(i.ARRAY_BUFFER,this.array,this.usage),i.bindBuffer(i.ARRAY_BUFFER,null),this},setAsInterleavedArray:function(t){for(var i=t.length,e=t[0].data.length/t[0].unitSize,n=[],r=0;r<e;r++)for(var s=0;s<i;s++)for(var a=t[s],h=0;h<a.unitSize;h++)n.push(a.data[r*a.unitSize+h]);return this.set(n)},bind:function(){var t=this.gl;return t.bindBuffer(t.ARRAY_BUFFER,this._vbo),this},"delete":function(){this.gl.deleteBuffer(this._vbo)},_static:{unbind:function(t){t.bindBuffer(t.ARRAY_BUFFER,null)}}})});