phina.namespace(function(){var t=WebGLRenderingContext;phina.define("phigl.Attribute",{gl:null,_location:null,_type:null,init:function(e,i,n){this.gl=e,this.name=n,this._location=e.getAttribLocation(i,n),e.enableVertexAttribArray(this._location);var r=e.getActiveAttrib(i,this._location);switch(this._type=r.type,r.type){case t.FLOAT:this.size=1,this._ptype=t.FLOAT;break;case t.FLOAT_VEC2:this.size=2,this._ptype=t.FLOAT;break;case t.FLOAT_VEC3:this.size=3,this._ptype=t.FLOAT;break;case t.FLOAT_VEC4:this.size=4,this._ptype=t.FLOAT}},specify:function(t,e){return this.gl.vertexAttribPointer(this._location,this.size,this._ptype,!1,t,e),this},_accessor:{value:{get:function(){return null},set:function(t){this.setValue(t)}}}})}),phina.namespace(function(){var t=WebGLRenderingContext;phina.define("phigl.Drawable",{superClass:"phina.util.EventDispatcher",gl:null,extVao:null,program:null,indices:null,attributes:null,stride:0,offsets:null,uniforms:null,vbo:null,drawMode:t.TRIANGLES,vao:null,init:function(t){this.superInit(),this.gl=t,this.attributes=[],this.offsets=[],this.uniforms={}},setDrawMode:function(t){return this.drawMode=t,this},setProgram:function(t){return this.program=t,this},setIndexValues:function(t){return this.indices||(this.indices=phigl.Ibo(this.gl)),this.indices.setValue(t),this},setAttributes:function(t){t=Array.prototype.concat.apply([],arguments);for(var e=0,i=0;i<t.length;i++){var n=t[i];"string"==typeof n&&(n=this.program.getAttribute(n)),this.attributes.push(n),this.offsets.push(e),e+=4*n.size}return this.stride=e,this},setAttributeData:function(t){return this.vbo||(this.vbo=phigl.Vbo(this.gl)),this.vbo.set(t),this},setAttributeDataArray:function(t){return this.vbo||(this.vbo=phigl.Vbo(this.gl)),this.vbo.setAsInterleavedArray(t),this},createVao:function(){var t=this.gl,e=this.stride,i=this.offsets;return this.extVao||(this.extVao=phigl.Extensions.getVertexArrayObject(t)),this.vao||(this.vao=this.extVao.createVertexArrayOES()),this.extVao.bindVertexArrayOES(this.vao),this.indices&&this.indices.bind(),this.vbo&&this.vbo.bind(),this.attributes.forEach(function(n,r){n.specify(e,i[r]),t.enableVertexAttribArray(n._location)}),this.extVao.bindVertexArrayOES(null),phigl.Ibo.unbind(t),phigl.Vbo.unbind(t),this},setUniforms:function(t){t=Array.prototype.concat.apply([],arguments);var e=this.program,i=Array.prototype.reduce.call(t,function(t,i){return t[i]=e.getUniform(i),t},{});return this.uniforms.$extend(i),this},draw:function(){var e=this.gl,i=this.extVao;if(this.program.use(),this.vao)i.bindVertexArrayOES(this.vao);else{this.indices&&this.indices.bind(),this.vbo&&this.vbo.bind();var n=this.stride,r=this.offsets;this.attributes.forEach(function(t,e){t.specify(n,r[e])})}this.uniforms.forIn(function(t,e){e.assign()}),this.flare("predraw"),this.gl.drawElements(this.drawMode,this.indices.length,t.UNSIGNED_SHORT,0),this.flare("postdraw"),this.vao?i.bindVertexArrayOES(null):(phigl.Ibo.unbind(e),phigl.Vbo.unbind(e))}})}),phina.namespace(function(){phina.define("phigl.Extensions",{_static:{getVertexArrayObject:function(t){return this._get(t,"OES_vertex_array_object")},getInstancedArrays:function(t){return this._get(t,"ANGLE_instanced_arrays")},_get:function(t,e){var i=t.getExtension(e);if(i)return i;throw e+" is not supported"}}})}),phina.namespace(function(){var t=WebGLRenderingContext;phina.define("phigl.Framebuffer",{gl:null,texture:null,_framebuffer:null,_depthRenderbuffer:null,_texture:null,init:function(e,i,n){this.gl=e,this.width=i,this.height=n,this.texture=phigl.Texture(e),this._framebuffer=e.createFramebuffer(),this._depthRenderbuffer=e.createRenderbuffer(),this._texture=this.texture._texture,e.bindFramebuffer(t.FRAMEBUFFER,this._framebuffer),e.bindRenderbuffer(t.RENDERBUFFER,this._depthRenderbuffer),e.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,i,n),e.bindTexture(t.TEXTURE_2D,this._texture),e.texImage2D(t.TEXTURE_2D,0,t.RGBA,i,n,0,t.RGBA,t.UNSIGNED_BYTE,null),e.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),e.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),e.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),e.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),e.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this._texture,0),e.bindTexture(t.TEXTURE_2D,null),e.bindRenderbuffer(t.RENDERBUFFER,null),e.bindFramebuffer(t.FRAMEBUFFER,null)},bind:function(){var e=this.gl;return e.bindFramebuffer(t.FRAMEBUFFER,this._framebuffer),e.viewport(0,0,this.width,this.height),this},unbind:function(){return this.gl.bindFramebuffer(t.FRAMEBUFFER,null),this}})}),phina.namespace(function(){var t=WebGLRenderingContext;phina.define("phigl.Ibo",{gl:null,length:0,_buffer:null,init:function(t){this.gl=t,this._buffer=t.createBuffer()},setValue:function(e){var i=this.gl;return i.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._buffer),i.bufferData(t.ELEMENT_ARRAY_BUFFER,new Int16Array(e),t.STATIC_DRAW),i.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),this.length=e.length,this},bind:function(){return this.gl.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._buffer),this},_static:{unbind:function(e){return e.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),this}},_accessor:{value:{get:function(){return null},set:function(t){this.setValue(t)}}}})}),phina.namespace(function(){var t=WebGLRenderingContext;phina.define("phigl.InstancedDrawable",{superClass:"phigl.Drawable",instanceAttributes:null,ext:null,instanceVbo:null,instanceStride:0,instanceOffsets:null,init:function(t){this.superInit(t),this.ext=phigl.Extensions.getInstancedArrays(t),this.instanceAttributes=[],this.instanceOffsets=[]},setInstanceAttributes:function(t){t=Array.prototype.concat.apply([],arguments);for(var e=(this.gl,this.ext),i=0,n=0;n<t.length;n++){var r=t[n];"string"==typeof r&&(r=this.program.getAttribute(r)),this.instanceAttributes.push(r),this.instanceOffsets.push(i),i+=4*r.size,e.vertexAttribDivisorANGLE(r._location,1)}return this.instanceStride=i,this},setInstanceAttributeData:function(e){return this.instanceVbo||(this.instanceVbo=phigl.Vbo(this.gl,t.DYNAMIC_DRAW)),this.instanceVbo.set(e),this},setInstanceAttributeDataArray:function(t){return this.instanceVbo||(this.instanceVbo=phigl.Vbo(this.gl)),this.instanceVbo.setAsInterleavedArray(t),this},createVao:function(){return this},draw:function(e){var i=this.gl,n=this.extVao;if(this.program.use(),this.vao)n.bindVertexArrayOES(this.vao);else{this.indices&&this.indices.bind(),this.vbo&&this.vbo.bind();var r=this.stride,s=this.offsets;this.attributes.forEach(function(t,e){t.specify(r,s[e])});var a=this.instanceStride,h=this.instanceOffsets;this.instanceVbo&&this.instanceVbo.bind(),this.instanceAttributes.forEach(function(t,e){t.specify(a,h[e])})}this.uniforms.forIn(function(t,e){e.assign()}),this.flare("predraw"),this.ext.drawElementsInstancedANGLE(this.drawMode,this.indices.length,t.UNSIGNED_SHORT,0,e),this.flare("postdraw"),this.vao?n.bindVertexArrayOES(null):(phigl.Ibo.unbind(i),phigl.Vbo.unbind(i))}})}),phina.namespace(function(){var t=WebGLRenderingContext,e=0;phina.define("phigl.Program",{gl:null,linked:!1,_program:null,_vbo:null,_attributes:null,_uniforms:null,init:function(t){this.gl=t,this._program=t.createProgram(),this._program._id=e++,this.linked=!1,this._attributes={},this._uniforms={}},attach:function(t){var e=this.gl;return"string"==typeof t&&(t=phina.asset.AssetManager.get("vertexShader",t)||phina.asset.AssetManager.get("fragmentShader",t)),t.compiled||t.compile(e),e.attachShader(this._program,t._shader),this},link:function(){var e=this.gl;if(e.linkProgram(this._program),e.getProgramParameter(this._program,t.LINK_STATUS)){for(var i=e.getProgramParameter(this._program,t.ACTIVE_ATTRIBUTES),n=0;i>n;n++){var r=e.getActiveAttrib(this._program,n);this.getAttribute(r.name,r.type)}for(var s=e.getProgramParameter(this._program,t.ACTIVE_UNIFORMS),n=0;s>n;n++){var a=e.getActiveUniform(this._program,n);this.getUniform(a.name,a.type)}return this.linked=!0,this}throw this.linked=!1,e.getProgramInfoLog(this._program)},getAttribute:function(t){return this._attributes[t]||(this._attributes[t]=phigl.Attribute(this.gl,this._program,t)),this._attributes[t]},getUniform:function(t,e){return this._uniforms[t]||(this._uniforms[t]=phigl.Uniform(this.gl,this._program,t,e)),this._uniforms[t]},use:function(){return this.gl.useProgram(this._program),this}})}),phina.namespace(function(){var t=WebGLRenderingContext;phina.define("phigl.Shader",{superClass:"phina.asset.File",type:null,gl:null,compiled:!1,_shader:null,init:function(){this.superInit(),this.compiled=!1},compile:function(t){if(this.gl=t,this._shader=t.createShader(this.type),t.shaderSource(this._shader,this.data),t.compileShader(this._shader),t.getShaderParameter(this._shader,t.COMPILE_STATUS))return this.compiled=!0,this;throw this.compiled=!1,t.getShaderInfoLog(this._shader)}}),phina.define("phigl.VertexShader",{superClass:"phigl.Shader",init:function(){this.superInit(),this.type=t.VERTEX_SHADER}}),phina.asset.AssetLoader.assetLoadFunctions.vertexShader=function(t,e){var i=phigl.VertexShader();return i.load({path:e})},phina.define("phigl.FragmentShader",{superClass:"phigl.Shader",init:function(){this.superInit(),this.type=t.FRAGMENT_SHADER}}),phina.asset.AssetLoader.assetLoadFunctions.fragmentShader=function(t,e){var i=phigl.FragmentShader();return i.load({path:e})}}),phina.namespace(function(){var t=WebGLRenderingContext;phina.define("phigl.Texture",{gl:null,_texture:null,init:function(t,e){this.gl=t,this._texture=t.createTexture(),e&&this.setImage(e)},setImage:function(e,i){var n=this.gl;return"string"==typeof e&&(e=phina.asset.AssetManager.get("image",e)),n.bindTexture(t.TEXTURE_2D,this._texture),n.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e.domElement),n.generateMipmap(t.TEXTURE_2D),n.bindTexture(t.TEXTURE_2D,null),this},bind:function(e){var i=this.gl;return i.activeTexture(t.TEXTURE0+(e||0)),i.bindTexture(t.TEXTURE_2D,this._texture),this},unbind:function(){var e=this.gl;return e.bindTexture(t.TEXTURE_2D,null),this}})}),phina.namespace(function(){var t=WebGLRenderingContext;phina.define("phigl.Uniform",{gl:null,name:null,texture:null,_location:null,_value:null,_type:null,_uniformMethod:null,init:function(e,i,n,r){switch(this.gl=e,this.name=n,this._location=e.getUniformLocation(i,n),this._type=r,r){case t.FLOAT:this._uniformMethod="uniform1f";break;case t.FLOAT_VEC2:this._uniformMethod="uniform2fv";break;case t.FLOAT_VEC3:this._uniformMethod="uniform3fv";break;case t.FLOAT_VEC4:this._uniformMethod="uniform4fv";break;case t.FLOAT_MAT2:this._uniformMethod="uniformMatrix2fv";break;case t.FLOAT_MAT3:this._uniformMethod="uniformMatrix3fv";break;case t.FLOAT_MAT4:this._uniformMethod="uniformMatrix4fv";break;case t.SAMPLER_2D:this._uniformMethod="uniform1i"}},setValue:function(t){return this._value=t,this},setTexture:function(t){return this.texture=t,this},assign:function(){var e=this.gl;switch(this._type){case t.FLOAT:case t.FLOAT_VEC2:case t.FLOAT_VEC3:case t.FLOAT_VEC4:e[this._uniformMethod](this._location,this._value);break;case t.FLOAT_MAT2:case t.FLOAT_MAT3:case t.FLOAT_MAT4:e[this._uniformMethod](this._location,!1,this._value);break;case t.SAMPLER_2D:this.texture&&this.texture.bind(this._value),e[this._uniformMethod](this._location,this._value)}return this},_accessor:{value:{get:function(){return this._value},set:function(t){this.setValue(t)}}}})}),phina.namespace(function(){var t=WebGLRenderingContext;phina.define("phigl.Vbo",{gl:null,usage:null,_vbo:null,init:function(e,i){this.gl=e,this.usage=i||t.STATIC_DRAW,this._vbo=e.createBuffer()},set:function(e){var i=this.gl;return i.bindBuffer(t.ARRAY_BUFFER,this._vbo),i.bufferData(t.ARRAY_BUFFER,new Float32Array(e),this.usage),i.bindBuffer(t.ARRAY_BUFFER,null),this},setAsInterleavedArray:function(t){for(var e=t[0].data.length/t[0].unitSize,i=[],n=0;e>n;n++)t.forEach(function(t){for(var e=0;e<t.unitSize;e++)i.push(t.data[n*t.unitSize+e])});return this.set(i)},bind:function(){return this.gl.bindBuffer(t.ARRAY_BUFFER,this._vbo),this},_static:{unbind:function(e){e.bindBuffer(t.ARRAY_BUFFER,null)}}})});