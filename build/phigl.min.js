phina.namespace(function(){phina.define("phigl.Attribute",{gl:null,name:null,_location:null,_type:null,_ptype:null,init:function(t,i,e,n){if(this.gl=t,this.name=e,this._location=t.getAttribLocation(i,e),-1==this._location)throw"attribute "+e+" not found";switch(t.enableVertexAttribArray(this._location),this._type=n,n){case t.FLOAT:this.size=1,this._ptype=t.FLOAT;break;case t.FLOAT_VEC2:this.size=2,this._ptype=t.FLOAT;break;case t.FLOAT_VEC3:this.size=3,this._ptype=t.FLOAT;break;case t.FLOAT_VEC4:this.size=4,this._ptype=t.FLOAT}},specify:function(t,i){var e=this.gl;return e.vertexAttribPointer(this._location,this.size,this._ptype,!1,t,i),this}})}),phina.namespace(function(){phina.define("phigl.Drawable",{superClass:"phina.util.EventDispatcher",gl:null,extVao:null,program:null,indices:null,attributes:null,stride:0,offsets:null,uniforms:null,vbo:null,drawMode:0,vao:null,init:function(t,i){this.superInit(),this.gl=t,this.extVao=i,this.attributes=[],this.offsets=[],this.uniforms={},this.drawMode=t.TRIANGLES},setDrawMode:function(t){return this.drawMode=t,this},setProgram:function(t){return this.program=t,t.use(),this},setIndexValues:function(t){return this.indices||(this.indices=phigl.Ibo(this.gl)),this.indices.set(t),this},setIbo:function(t){return this.indices=t,this},setAttributes:function(t){t=Array.prototype.concat.apply([],arguments);for(var i=0,e=0;e<t.length;e++){var n=t[e];"string"==typeof n&&(n=this.program.getAttribute(n)),this.attributes.push(n),this.offsets.push(i),i+=4*n.size}return this.stride=i,this},setAttributeData:function(t,i){this.vbo||(this.vbo=phigl.Vbo(this.gl,i)),this.vbo.set(t),this.vbo.bind();var e=this.stride,n=this.offsets;return this.attributes.forEach(function(t,i){t.specify(e,n[i])}),phigl.Vbo.unbind(this.gl),this},setAttributeDataArray:function(t,i){this.vbo||(this.vbo=phigl.Vbo(this.gl,i)),this.vbo.setAsInterleavedArray(t),this.vbo.bind();var e=this.stride,n=this.offsets;return this.attributes.forEach(function(t,i){t.specify(e,n[i])}),phigl.Vbo.unbind(this.gl),this},setAttributeVbo:function(t){this.vbo=t,this.vbo.bind();var i=this.stride,e=this.offsets;return this.attributes.forEach(function(t,n){t.specify(i,e[n])}),phigl.Vbo.unbind(this.gl),this},createVao:function(){var t=this.gl,i=this.stride,e=this.offsets;return this.extVao||(this.extVao=phigl.Extensions.getVertexArrayObject(t)),this.vao||(this.vao=this.extVao.createVertexArrayOES()),this.extVao.bindVertexArrayOES(this.vao),this.indices&&this.indices.bind(),this.vbo&&this.vbo.bind(),this.attributes.forEach(function(n,s){n.specify(i,e[s]),t.enableVertexAttribArray(n._location)}),this.extVao.bindVertexArrayOES(null),phigl.Ibo.unbind(t),phigl.Vbo.unbind(t),this},setUniforms:function(t){t=Array.prototype.concat.apply([],arguments);var i=this.program,e=Array.prototype.reduce.call(t,function(t,e){return t[e]=i.getUniform(e),t},{});return this.uniforms.$extend(e),this},draw:function(){var t=this.gl,i=this.extVao;if(this.program.use(),this.vao)i.bindVertexArrayOES(this.vao);else{this.indices&&this.indices.bind(),this.vbo&&this.vbo.bind();var e=this.stride,n=this.offsets;this.attributes.forEach(function(t,i){t.specify(e,n[i])})}this.uniforms.forIn(function(t,i){i.assign()}),this.flare("predraw"),this.gl.drawElements(this.drawMode,this.indices.length,t.UNSIGNED_SHORT,0),this.flare("postdraw"),this.vao?i.bindVertexArrayOES(null):(phigl.Ibo.unbind(t),phigl.Vbo.unbind(t)),this.uniforms.forIn(function(t,i){i.reassign()})}})}),phina.namespace(function(){phina.define("phigl.Extensions",{_static:{getVertexArrayObject:function(t){return this._get(t,"OES_vertex_array_object")},getInstancedArrays:function(t){return this._get(t,"ANGLE_instanced_arrays")},_get:function(t,i){var e=t.getExtension(i);if(e)return e;throw i+" is not supported"}}})}),phina.namespace(function(){phina.define("phigl.Framebuffer",{gl:null,texture:null,_framebuffer:null,_depthRenderbuffer:null,_texture:null,init:function(t,i,e){this.gl=t,this.width=i,this.height=e,this.texture=phigl.Texture(t),this._framebuffer=t.createFramebuffer(),this._depthRenderbuffer=t.createRenderbuffer(),this._texture=this.texture._texture,t.bindFramebuffer(t.FRAMEBUFFER,this._framebuffer),t.bindRenderbuffer(t.RENDERBUFFER,this._depthRenderbuffer),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,i,e),t.bindTexture(t.TEXTURE_2D,this._texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,i,e,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this._texture,0),t.bindTexture(t.TEXTURE_2D,null),t.bindRenderbuffer(t.RENDERBUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,null)},bind:function(){var t=this.gl;return t.bindFramebuffer(t.FRAMEBUFFER,this._framebuffer),t.viewport(0,0,this.width,this.height),this},unbind:function(){return this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this}})}),phina.namespace(function(){phina.define("phigl.Ibo",{gl:null,length:0,_buffer:null,init:function(t){this.gl=t,this._buffer=t.createBuffer()},setValue:function(t){var i=this.gl;return i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this._buffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,new Int16Array(t),i.STATIC_DRAW),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),this.length=t.length,this},bind:function(){return this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this._buffer),this},"delete":function(){this.gl.deleteBuffer(this._buffer)},_static:{unbind:function(t){return t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),this}},_accessor:{value:{get:function(){return null},set:function(t){this.setValue(t)}}}})}),phina.namespace(function(){phina.define("phigl.InstancedDrawable",{superClass:"phigl.Drawable",instanceAttributes:null,ext:null,instanceVbo:null,instanceStride:0,instanceOffsets:null,init:function(t,i){this.superInit(t),this.ext=i,this.instanceAttributes=[],this.instanceOffsets=[]},setInstanceAttributes:function(t){t=Array.prototype.concat.apply([],arguments);for(var i=(this.gl,this.ext,0),e=0;e<t.length;e++){var n=t[e];"string"==typeof n&&(n=this.program.getAttribute(n)),this.instanceAttributes.push(n),this.instanceOffsets.push(i),i+=4*n.size}return this.instanceStride=i,this},setInstanceAttributeData:function(t){this.instanceVbo||(this.instanceVbo=phigl.Vbo(this.gl,this.gl.DYNAMIC_DRAW)),this.instanceVbo.set(t),this.instanceVbo.bind();var i=this.instanceStride,e=this.instanceOffsets;return this.instanceAttributes.forEach(function(t,n){t.specify(i,e[n])}),phigl.Vbo.unbind(this.gl),this},setInstanceAttributeDataArray:function(t){this.instanceVbo||(this.instanceVbo=phigl.Vbo(this.gl)),this.instanceVbo.setAsInterleavedArray(t),this.instanceVbo.bind();var i=this.instanceStride,e=this.instanceOffsets;return this.instanceAttributes.forEach(function(t,n){t.specify(i,e[n])}),phigl.Vbo.unbind(this.gl),this},createVao:function(){return this},draw:function(t){var i=this.gl,e=this.ext;this.program.use(),this.indices&&this.indices.bind(),this.vbo&&this.vbo.bind();var n=this.stride,s=this.offsets;this.attributes.forEach(function(t,i){t.specify(n,s[i])}),this.instanceVbo&&this.instanceVbo.bind();var r=this.instanceStride,a=this.instanceOffsets;this.instanceAttributes.forEach(function(t,i){t.specify(r,a[i]),e.vertexAttribDivisorANGLE(t._location,1)}),this.uniforms.forIn(function(t,i){i.assign()}),this.flare("predraw"),this.ext.drawElementsInstancedANGLE(this.drawMode,this.indices.length,i.UNSIGNED_SHORT,0,t),this.flare("postdraw"),this.instanceAttributes.forEach(function(t,i){e.vertexAttribDivisorANGLE(t._location,0)}),phigl.Ibo.unbind(i),phigl.Vbo.unbind(i)}})}),phina.namespace(function(){var t=0;phina.define("phigl.Program",{gl:null,linked:!1,_program:null,_vbo:null,_attributes:null,_uniforms:null,init:function(i){this.gl=i,this._program=i.createProgram(),this._program._id=t++,this.linked=!1,this._attributes={},this._uniforms={}},attach:function(t){var i=this.gl;return"string"==typeof t&&(t=phina.asset.AssetManager.get("vertexShader",t)||phina.asset.AssetManager.get("fragmentShader",t)),t.compiled||t.compile(i),i.attachShader(this._program,t._shader),this},link:function(){var t=this.gl;if(t.linkProgram(this._program),t.getProgramParameter(this._program,t.LINK_STATUS)){for(var i=t.getProgramParameter(this._program,t.ACTIVE_ATTRIBUTES),e=0;i>e;e++){var n=t.getActiveAttrib(this._program,e);this.getAttribute(n.name,n.type)}for(var s=t.getProgramParameter(this._program,t.ACTIVE_UNIFORMS),e=0;s>e;e++){var r=t.getActiveUniform(this._program,e);this.getUniform(r.name,r.type)}return this.linked=!0,this}throw this.linked=!1,t.getProgramInfoLog(this._program)},getAttribute:function(t,i){return this._attributes[t]||(this._attributes[t]=phigl.Attribute(this.gl,this._program,t,i)),this._attributes[t]},getUniform:function(t,i){return this._uniforms[t]||(this._uniforms[t]=phigl.Uniform(this.gl,this._program,t,i)),this._uniforms[t]},use:function(){return this.gl.useProgram(this._program),this}})}),phina.namespace(function(){phina.define("phigl.Shader",{superClass:"phina.asset.File",type:null,gl:null,compiled:!1,_shader:null,init:function(){this.superInit(),this.compiled=!1},compile:function(t){if(this.gl=t,this.type=this._type(t),this._shader=t.createShader(this.type),t.shaderSource(this._shader,this.data),t.compileShader(this._shader),t.getShaderParameter(this._shader,t.COMPILE_STATUS))return this.compiled=!0,this;throw this.compiled=!1,t.getShaderInfoLog(this._shader)},_type:function(t){return 0}}),phina.define("phigl.VertexShader",{superClass:"phigl.Shader",init:function(){this.superInit()},_type:function(t){return t.VERTEX_SHADER}}),phina.asset.AssetLoader.assetLoadFunctions.vertexShader=function(t,i){var e=phigl.VertexShader();return e.load({path:i})},phina.define("phigl.FragmentShader",{superClass:"phigl.Shader",init:function(){this.superInit()},_type:function(t){return t.FRAGMENT_SHADER}}),phina.asset.AssetLoader.assetLoadFunctions.fragmentShader=function(t,i){var e=phigl.FragmentShader();return e.load({path:i})}}),phina.namespace(function(){phina.define("phigl.Texture",{gl:null,_texture:null,init:function(t,i){this.gl=t,this._texture=t.createTexture(),i&&this.setImage(i)},setImage:function(t){var i=this.gl;return"string"==typeof t&&(t=phina.asset.AssetManager.get("image",t)),i.bindTexture(i.TEXTURE_2D,this._texture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t.domElement),i.generateMipmap(i.TEXTURE_2D),i.bindTexture(i.TEXTURE_2D,null),this},bind:function(t){var i=this.gl;return i.activeTexture(i["TEXTURE"+(t||0)]),i.bindTexture(i.TEXTURE_2D,this._texture),this},"delete":function(){this.gl.deleteTexture(this._texture)},_static:{unbind:function(t){return t.bindTexture(t.TEXTURE_2D,null),this}}})}),phina.namespace(function(){phina.define("phigl.Uniform",{gl:null,name:null,texture:null,_location:null,_value:null,_type:null,_uniformMethod:null,init:function(t,i,e,n){switch(this.gl=t,this.name=e,this._location=t.getUniformLocation(i,e),this._type=n,n){case t.FLOAT:this._uniformMethod="uniform1f";break;case t.FLOAT_VEC2:this._uniformMethod="uniform2fv";break;case t.FLOAT_VEC3:this._uniformMethod="uniform3fv";break;case t.FLOAT_VEC4:this._uniformMethod="uniform4fv";break;case t.FLOAT_MAT2:this._uniformMethod="uniformMatrix2fv";break;case t.FLOAT_MAT3:this._uniformMethod="uniformMatrix3fv";break;case t.FLOAT_MAT4:this._uniformMethod="uniformMatrix4fv";break;case t.SAMPLER_2D:this._uniformMethod="uniform1i"}},setValue:function(t){return this._value=t,this},setTexture:function(t){return this.texture=t,this},assign:function(){var t=this.gl;switch(this._type){case t.FLOAT:case t.FLOAT_VEC2:case t.FLOAT_VEC3:case t.FLOAT_VEC4:t[this._uniformMethod](this._location,this._value);break;case t.FLOAT_MAT2:case t.FLOAT_MAT3:case t.FLOAT_MAT4:t[this._uniformMethod](this._location,!1,this._value);break;case t.SAMPLER_2D:this.texture&&this.texture.bind(this._value),t[this._uniformMethod](this._location,this._value)}return this},reassign:function(){var t=this.gl;switch(this._type){case t.SAMPLER_2D:this.texture&&this.texture.unbind()}return this},_accessor:{value:{get:function(){return this._value},set:function(t){this.setValue(t)}}}})}),phina.namespace(function(){var t=0;phina.define("phigl.Vbo",{gl:null,usage:null,_vbo:null,array:null,init:function(i,e){this.gl=i,this.usage=e||i.STATIC_DRAW,this._vbo=i.createBuffer(),this._vbo._id=t++},set:function(t){var i=this.gl;return this.array?this.array.set(t):this.array=new Float32Array(t),i.bindBuffer(i.ARRAY_BUFFER,this._vbo),i.bufferData(i.ARRAY_BUFFER,this.array,this.usage),i.bindBuffer(i.ARRAY_BUFFER,null),this},setAsInterleavedArray:function(t){for(var i=t[0].data.length/t[0].unitSize,e=[],n=0;i>n;n++)t.forEach(function(t){for(var i=0;i<t.unitSize;i++)e.push(t.data[n*t.unitSize+i])});return this.set(e)},bind:function(){var t=this.gl;return t.bindBuffer(t.ARRAY_BUFFER,this._vbo),this},"delete":function(){this.gl.deleteBuffer(this._vbo)},_static:{unbind:function(t){t.bindBuffer(t.ARRAY_BUFFER,null)}}})});